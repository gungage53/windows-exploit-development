#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
int main(int argc, char ** argv)
{
	int stacktest = 0;
	DWORD flOldProtect = 0;
	
	printf("&stacktest = %p\n", &stacktest);
	
	FILE *fp;
	int size;
	char* buf;
	
	//file open
	fp = fopen(argv[1],"rb");
	
	//file size
	fseek(fp, 0, SEEK_END);
	size = ftell(fp);
	fseek(fp, 0, SEEK_SET);
	
	//copy buf
	buf = (char*)malloc(sizeof(char) * size);
	fread(buf,size,sizeof(char),fp);
	
	//file close
	fclose(fp);
	
	printf("execute shellcode? Y/N\n");	
	
	char y;
	scanf("%s", &y);
	if(y == 'y'){
		//64bitアプリケーションでは、DEPは常に有効となり、/NXCOMPATリンカオプションは無視される。 
		//したがって、このコードではVirtualProtect関数を使い、シェルコードが置かれたメモリ領域を実行可能に変更している。
		VirtualProtect(buf, sizeof(buf), PAGE_EXECUTE_READWRITE, &flOldProtect);
		(*(void (*)())buf)();
		return 0;
	}else{
		return 0;	
	}
}
