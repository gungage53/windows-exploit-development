#!/usr/bin/python2 -V
# coding: Shift_JIS
import sys
import fnmatch
import pykd
from pykd import *

list = []

class MyBpObject():
	def __init__(self, isOneShot):
		self.bp_obj = None
		self.isOneShot = isOneShot
		self.funName = ""
		self.addr = 0
		
	def callBack(self):
		print("-------------------------------------------------------------------------------")
		print("Break:{0:x}\t{1}".format(self.addr, self.funcName))
		print(dbgCommand("r"))
		print(dbgCommand("dds esp"))
		if self.isOneShot == True:
			self.bp_obj.remove()
		return False
		
	def setBreakPoint(self, addr, funcName):
		self.addr = addr
		self.funcName = funcName
		
		#ì‡ïîÇ≈ï€éùÇµÇƒÇ®Ç©Ç»Ç¢Ç∆ÅAè¡Ç≥ÇÍÇÈÅB
		self.bp_obj = pykd.setBp(int(addr), self.callBack)
		
		return
		
def export( moduleName, mask = "*" ):

    modObj = module( moduleName )
    dprintln( "Module: " + moduleName + " base: %x" % modObj.begin() + " end: %x" % modObj.end() )

    if isKernelDebugging():
        systemModule = module( "nt" )
    else:
        systemModule = module( "ntdll" )
   

    if is64bitSystem():
        ntHeader = systemModule.typedVar( "_IMAGE_NT_HEADERS64", modObj.begin() + ptrDWord( modObj.begin() + 0x3c ) )
        if ntHeader.OptionalHeader.Magic == 0x10b:
            systemModule = module( "ntdll32" ) 
            ntHeader = systemModule.typedVar( "_IMAGE_NT_HEADERS", modObj.begin() + ptrDWord( modObj.begin() + 0x3c ) )

    else:
        ntHeader = systemModule.typedVar("_IMAGE_NT_HEADERS", modObj.begin() + ptrDWord( modObj.begin() + 0x3c ) )


    dprintln( "Export RVA: %x  Size: %x" % ( ntHeader.OptionalHeader.DataDirectory[0].VirtualAddress, ntHeader.OptionalHeader.DataDirectory[0].Size  ) )
    dprintln( "========================" )

    if ntHeader.OptionalHeader.DataDirectory[0].Size == 0:
        return
    
    exportDirAddr = modObj.begin() + ntHeader.OptionalHeader.DataDirectory[0].VirtualAddress;
    
    namesCount = ptrDWord( exportDirAddr + 0x18 )
    
    namesRva = modObj.begin() + ptrDWord( exportDirAddr + 0x20 ) 
    ordRva = modObj.begin() + ptrDWord( exportDirAddr + 0x24) 
    addrRva = modObj.begin() + ptrDWord( exportDirAddr + 0x1c) 
    
    for i in range( 0, namesCount ):
        
        exportName = loadCStr( modObj.begin() + ptrDWord( namesRva + 4 * i ) )
        if fnmatch.fnmatch( exportName, mask ): 
            ord = ptrWord(ordRva + i * 2)
            func =  modObj.begin() + ptrDWord(addrRva + ord * 4)
            myBp = MyBpObject(True)
            myBp.setBreakPoint(func, exportName)
            list.append(myBp)


if __name__ == "__main__":
    if not isWindbgExt():
        print "script is launch out of windbg"
        quit( 0 )

    if len (sys.argv)<=1:
        dprintln( "usage: !py export module_name ( symbol name mask )" )
        quit( 0 )
    elif len( sys.argv ) == 2:
        export( sys.argv[1] )
    else:
        export( sys.argv[1], sys.argv[2] )
        
    print("set breakpoint Num={0}".format(pykd.getNumberBreakpoints()))
    pykd.go()

